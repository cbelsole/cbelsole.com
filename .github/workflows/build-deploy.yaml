name: build deploy hugo

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1 # v2 does not have submodules option now

      # with:
      #   submodules: true
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.65.2"
          # extended: true
      # - name: Setup AWS
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-west-2

      - name: Build Static Site
        run: hugo --minify

      # - name: Deploy to S3
      #   # run: aws s3 sync public/ s3://${{ secrets.AWS_S3_BUCKET }}/ --acl public-read --follow-symlinks --delete --exact-timestamps
      #   run: aws s3 sync ./public/ s3://${{ secrets.AWS_S3_BUCKET }} --delete
      - name: Deploy to S3
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends s3cmd
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get clean -y
          cat >> /home/runner/.s3cfg <<EOL
          [default]
          access_key = ${{ secrets.AWS_ACCESS_KEY_ID }}
          access_token =
          add_encoding_exts =
          add_headers =
          bucket_location = us-east-1
          ca_certs_file =
          cache_file =
          check_ssl_certificate = True
          check_ssl_hostname = True
          cloudfront_host = cloudfront.amazonaws.com
          content_disposition =
          content_type =
          default_mime_type = binary/octet-stream
          delay_updates = False
          delete_after = False
          delete_after_fetch = False
          delete_removed = False
          dry_run = False
          enable_multipart = True
          encoding = UTF-8
          encrypt = False
          expiry_date =
          expiry_days =
          expiry_prefix =
          follow_symlinks = False
          force = False
          get_continue = False
          gpg_command = None
          gpg_decrypt = %(gpg_command)s -d --verbose --no-use-agent --batch --yes --passphrase-fd %(passphrase_fd)s -o %(output_file)s %(input_file)s
          gpg_encrypt = %(gpg_command)s -c --verbose --no-use-agent --batch --yes --passphrase-fd %(passphrase_fd)s -o %(output_file)s %(input_file)s
          gpg_passphrase =
          guess_mime_type = True
          host_base = s3.amazonaws.com
          host_bucket = %(bucket)s.s3.amazonaws.com
          human_readable_sizes = False
          invalidate_default_index_on_cf = False
          invalidate_default_index_root_on_cf = True
          invalidate_on_cf = False
          kms_key =
          limit = -1
          limitrate = 0
          list_md5 = False
          log_target_prefix =
          long_listing = False
          max_delete = -1
          mime_type =
          multipart_chunk_size_mb = 15
          multipart_max_chunks = 10000
          preserve_attrs = True
          progress_meter = True
          proxy_host =
          proxy_port = 0
          put_continue = False
          recursive = False
          recv_chunk = 65536
          reduced_redundancy = False
          requester_pays = False
          restore_days = 1
          restore_priority = Standard
          secret_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          send_chunk = 65536
          server_side_encryption = False
          signature_v2 = False
          signurl_use_https = False
          simpledb_host = sdb.amazonaws.com
          skip_existing = False
          socket_timeout = 300
          stats = False
          stop_on_error = False
          storage_class =
          throttle_max = 100
          upload_id =
          urlencoding_mode = normal
          use_http_expect = False
          use_https = True
          use_mime_magic = True
          verbosity = WARNING
          website_endpoint = http://%(bucket)s.s3-website-%(location)s.amazonaws.com/
          website_error =
          website_index = index.html
          EOL
          s3cmd sync public/* s3://cbelsole.com/ --delete-removed
